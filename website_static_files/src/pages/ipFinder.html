<!DOCTYPE html>
<html>
  <head>
    <title>ROV IP Finder</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    </head>

  <body>
    <button onclick="scanForRovIp()">Scan for ROV IP</button>
    <!-- <div
          id="iframe_container"
          style="visibility: hidden; height: 10px; width: 10px;"
        ></div> -->
    <script>
        // make the list of possible rov IPs
        var currentIpComboArrayIndex = 0;
        const ipCombos = ["raspberrypi.local"];
        for (var octet = 0; octet < 255; octet++) {
          ipCombos.push(`192.168.${octet}.88`);
        }

        function scanForRovIp() {
          // document.writeln(ipCombos.join("<br/>"));
          findRovLocalIp();
        }

        function findRovLocalIp() {
        var interval = null;
        var rovLocalIp = null;
        var testPopup = null;
        const popupMessageHandler = (msg) => {
          if (typeof msg.data == typeof "string") {
            var parts = msg.data.split(": ");
            if (parts[0] == "ROV_IP") {
              rovLocalIp = parts[1];
              clearInterval(interval);
              testPopup.close();
              alert("ROV IP FOUND! " + rovLocalIp);
              window.removeEventListener("message", popupMessageHandler, false);
              resolve();
            }
          }
        };
        window.addEventListener("message", popupMessageHandler, false);

        // open the popup window
        testPopup = window.open(
          "",
          "ROV IP FINDER",
          "scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=6,height=3,left=0,top=0"
        );
        window.focus();

        testPopup.document.body.innerHTML = `Scanning for ROV IP...<br/>May take up to 4 minutes<img onload="
              window.onbeforeunload=()=>{
                document.writeln('Checkindg ROV IP ${currentIpComboArrayIndex}/${ipCombos.length}: ${ipCombos[currentIpComboArrayIndex]} ...');
                window.close()
              };
            " src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" >`;

        currentIpComboArrayIndex--; // so we start at zero
        interval = setInterval(() => {
          currentIpComboArrayIndex++;
          try {
            if (testPopup.closed) throw "popup was closed";
            if (currentIpComboArrayIndex >= ipCombos.length)
              throw "reached end of possible IP addresses";
            testPopup.stop();
            testPopup.location = `http://${ipCombos[currentIpComboArrayIndex]}/ipResponder`;
          } catch (e) {
            if (testPopup && testPopup.open) testPopup.close();
            clearInterval(interval);
            if (rovLocalIp == null) {
              alert(
                `ROV IP scan stopped because ${e}. Click Scan button again to continue...`
              );
            }
            window.removeEventListener("message", popupMessageHandler, false);
          }
        }, 1000);
      }

      // ---- multiple popup attempt: ----
      // -------------------------------
      // var rovLocalIp = null;
      // var currentIpComboArrayIndex = 0;
      // var ipCombos = ["raspberrypi.local"];
      // for (var octet = 0; octet < 255; octet++) {
      //   ipCombos.push(`192.168.${octet}.88`);
      // }
      // function scanForRovIp() {

      //   document.writeln(ipCombos.join("<br/>"));
      // }

      // function findRovLocalIp() {
      //   // window.addEventListener(
      //   //   "message",
      //   //   (msg) => {
      //   //     if (typeof msg.data == typeof "string") {
      //   //       var parts = msg.data.split(": ");
      //   //       if (parts[0] == "ROV_IP") {
      //   //         rovLocalIp = parts[1];
      //   //         clearInterval(interval);
      //   //         testPopup.close();
      //   //         alert("ROV IP FOUND! " + rovLocalIp);
      //   //         resolve();
      //   //       }
      //   //     }
      //   //   },
      //   //   false
      //   // );
      //   return new Promise((resolve, reject) => {
      //     var popupWindows = [];
      //     for (var i = 0; i < 2; i++) {
      //       const popup = window.open(
      //         ``, //http://${ipCombos[i]}/ipResponder
      //         "ROV IP FINDER " + i,
      //         `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=6,height=3,left=${
      //           (i * 200) % window.screen.width
      //         },top=${Math.floor((i * 200) / window.screen.width) * 300}`
      //       );
      //       // var countdown = 10000;
      //       // setInterval(() => {
      //       //   document.write('Checking IP: ${ipCombos[i]}' + (countdown--));
      //       //   if(countdown <= 0) window.close();
      //       // },1);
      //       popup.document.body.innerHTML = `<img onload="
      //         document.write('Checking IP: ${ipCombos[i]}');
      //         window.onbeforeunload=()=>{
      //           document.writeln('Nope IP: ${ipCombos[i]}');
      //           window.close()
      //         };
      //         window.location='http://${ipCombos[i]}/ipResponder'
      //       " src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" >`;
      //       if (!popup.open) {
      //         alert(
      //           "Please allow popups in your browser, and don't close the popups. Then try scanning again."
      //         );
      //         return reject();
      //       }
      //       window.focus();
      //       popupWindows.push(popup);
      //     }
      //     interval = setTimeout(() => {
      //       while (popupWindows.length > 0) {
      //         const popupWin = popupWindows.pop();
      //         if (popupWin.open) popupWin.close();
      //       }
      //     }, 20000);
      //     //http://raspberrypi.local/ipResponder
      //     window.focus();
      //   });
      // }

      // ----- old iframe attempt: -------
      // ------------------------------------
      // function iframeTester(url) {
      //     var iframe = document.createElement('iframe');
      //     iframe.src = url;
      //     iframe_container.appendChild(iframe);
      //     document.writeln(url)
      // }
      //
      // // if (window.isSecureContext) {
      // //     // downgrade to insecure connection to allow iframes from rov
      // //     window.location.protocol = 'http:'
      // // } else {
      // var rovLocalIp = null;
      // var thirdIpOctet = 0;
      // var iframe_container = document.getElementById("iframe_container")
      // // try to brute force search for raspberrypi's ip address...
      // // ... in iframes to get around browser local network cross origin protections
      // window.addEventListener("message", (msg) => {
      //     if (typeof (msg.data) == typeof ("string")) {
      //         alert("ROV IP FOUND! " + rovLocalIp)
      //         //pass up the chain
      //         parentWindow = window.opener || window.parent
      //         parentWindow.postMessage(msg.data, "*")
      //         // var parts = msg.data.split(": ")
      //         // if (parts[0] == "ROV_IP") {
      //         //     rovLocalIp = parts[1]
      //         //     alert("ROV IP FOUND! " + rovLocalIp)
      //         //     // window.opener.p
      //         // }
      //     }
      // }, false)
      // iframeTester("http://raspberrypi.local/ipResponder")
      // for (let thirdIpOctet = 0; thirdIpOctet < 255; thirdIpOctet++) {
      //     iframeTester("http://192.168." + thirdIpOctet + ".88/ipResponder");
      // }
      // // }

      // ----- old script element attempt: -------
      // -----------------------------------------
      // var rovLocalIp = null
      // var rovIpFound = false;
      // function rovIsAlive() {
      //     rovIpFound = true;
      //     console.log("ROVISALIVE!!!")
      // }
      // function findRovLocalIp() {
      //     // try to brute force search for raspberrypi's ip address
      //     console.info("Searching for raspberrypi local ip address...")
      //     currentThirdOctet = -1
      //     var scriptElem = null
      //     function testIp(ipAddress) {
      //         return new Promise(function (resolve, reject) {
      //             console.info("Testing: ", ipAddress)
      //             if (scriptElem) document.body.removeChild(scriptElem)
      //             scriptElem = document.createElement("SCRIPT")
      //             scriptElem.setAttribute("src", "http://" + ipAddress)
      //             document.body.appendChild(scriptElem)
      //             setTimeout(function () {
      //                 resolve()
      //             }, 500)
      //         }).then(function () {
      //             if (rovIpFound == true) {
      //                 return ipAddress
      //             } else {
      //                 currentThirdOctet = (currentThirdOctet + 1) % 255
      //                 return testIp("192.168." + currentThirdOctet + ".88/alive")
      //             }
      //         })
      //     }
      //     testIp("192.168." + 0 + ".88/alive").then((localIp) => {
      //         rovLocalIp = localIp;
      //         console.info("ROV IP FOUND! " + rovLocalIp)
      //     })
      // }
    </script>
  </body>
</html>
